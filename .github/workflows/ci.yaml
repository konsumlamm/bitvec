name: ci
on:
  push: {}
  pull_request: {}

defaults:
  run:
    shell: bash

jobs:
  js:
    runs-on: ubuntu-latest
    env:
      version: javascript-unknown-ghcjs-9.6.2
    steps:
    - uses: actions/checkout@v3
    - uses: actions/cache@v3
      name: Cache cabal stuff
      with:
        path: |
          ~/.cabal/store
          dist-newstyle
        key: ${{ env.version }}
    - name: Setup
      run: |
        ghcup config add-release-channel https://raw.githubusercontent.com/haskell/ghcup-metadata/develop/ghcup-cross-0.0.8.yaml
        cabal update
    - name: Install JS toolchain
      run: |
        git clone https://github.com/emscripten-core/emsdk.git
        cd emsdk
        ./emsdk install latest
        ./emsdk activate latest
        source ./emsdk_env.sh
        cd ..
        emconfigure ghcup install ghc --set ${{ env.version }}
    - name: Build
      run: |
        cabal --with-compiler=javascript-unknown-ghcjs-ghc --with-hc-pkg=javascript-unknown-ghcjs-ghc-pkg build

  wasm:
    runs-on: ubuntu-latest
    env:
      version: wasm32-wasi-9.8.0.20230927
    steps:
    - uses: actions/checkout@v3
    - uses: actions/cache@v3
      name: Cache cabal stuff
      with:
        path: |
          ~/.cabal/store
          dist-newstyle
        key: ${{ env.version }}
    - name: Setup
      run: |
        ghcup config add-release-channel https://raw.githubusercontent.com/haskell/ghcup-metadata/develop/ghcup-cross-0.0.8.yaml
        cabal update
    - name: Install WASM toolchain
      run: |
        git clone https://gitlab.haskell.org/ghc/ghc-wasm-meta.git
        cd ghc-wasm-meta/
        export SKIP_GHC=yes
        ./setup.sh
        source ~/.ghc-wasm/env
        cd ..
        ghcup install ghc --set ${{ env.version }} -- --host=x86_64-linux --with-intree-gmp --with-system-libffi
    - name: Build
      run: |
        echo packages:. > cabal.project
        echo tests:True >> cabal.project
        echo "constraints:quickcheck-classes -semigroupoids -aeson -semirings" >> cabal.project
        cabal --with-compiler=wasm32-wasi-ghc --with-hc-pkg=wasm32-wasi-ghc-pkg test --test-show-details=direct
        cabal --with-compiler=wasm32-wasi-ghc --with-hc-pkg=wasm32-wasi-ghc-pkg test -f-simd --test-show-details=direct
